<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeGuardAI - G√©rer les Ruches</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 35px 40px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2.2em;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1em;
            font-weight: 400;
        }

        .navbar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 0;
        }

        .nav-links a {
            padding: 20px 25px;
            text-decoration: none;
            color: #4b5563;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-links a:hover {
            color: #2a5298;
            border-bottom-color: #2a5298;
        }

        .nav-links a.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95em;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background: #2a5298;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            background: #1e3c72;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        button.secondary {
            background: #6b7280;
        }

        button.danger {
            background: #ef4444;
        }

        .success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #065f46;
        }

        .error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #991b1b;
        }

        .info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #1e40af;
        }

        .ruches-list {
            display: grid;
            gap: 20px;
        }

        .ruche-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.2s;
        }

        .ruche-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ruche-info {
            flex: 1;
        }

        .ruche-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }

        .ruche-location {
            color: #6b7280;
            margin-bottom: 10px;
        }

        .ruche-meta {
            font-size: 0.85em;
            color: #9ca3af;
        }

        .ruche-actions {
            display: flex;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #1e3c72;
        }

        .close-btn {
            background: none;
            color: #6b7280;
            font-size: 1.5em;
            padding: 0;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .config-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            margin-top: 15px;
        }

        .config-box .highlight {
            color: #10b981;
            font-weight: bold;
        }

        .copy-btn {
            background: #6b7280;
            padding: 8px 16px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .steps {
            counter-reset: step;
        }

        .step {
            position: relative;
            padding-left: 40px;
            margin-bottom: 20px;
        }

        .step::before {
            counter-increment: step;
            content: counter(step);
            position: absolute;
            left: 0;
            top: 0;
            width: 30px;
            height: 30px;
            background: #2a5298;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <header>
        <h1>BeeGuardAI Dashboard</h1>
        <p class="subtitle">Syst√®me de surveillance des ruches en temps r√©el - Sorbonne Universit√©</p>
    </header>

    <div class="navbar">
        <div class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/manage-ruches.html" class="active">G√©rer Ruches</a>
            <a href="/api-keys.html">Cl√©s API</a>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div id="user-info-nav" style="color: #6b7280; font-size: 0.9em;"></div>
            <button onclick="logout()" style="padding: 8px 16px;">D√©connexion</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Ajouter une Nouvelle Ruche</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">
                Enregistrez les informations de votre ruche et obtenez la configuration pour votre Arduino/ESP32
            </p>

            <div id="message"></div>

            <div class="form-group">
                <label for="ruche-name">Nom de la ruche *</label>
                <input type="text" id="ruche-name" placeholder="Ex: Ruche Jussieu 01" required>
            </div>

            <div class="form-group">
                <label for="ruche-location">Localisation *</label>
                <input type="text" id="ruche-location" placeholder="Ex: Campus Jussieu - Toit B√¢timent 44" required>
            </div>

            <div class="form-group">
                <label for="ruche-notes">Notes (optionnel)</label>
                <textarea id="ruche-notes" placeholder="Informations additionnelles..."></textarea>
            </div>

            <button onclick="addRuche()" id="add-btn">Ajouter la Ruche</button>
        </div>

        <div class="card">
            <h2>Mes Ruches</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">
                Liste de toutes vos ruches enregistr√©es
            </p>
            <div id="ruches-list" class="ruches-list"></div>
        </div>
    </div>

    <!-- Modal pour configuration Arduino -->
    <div id="config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuration Arduino/ESP32</h3>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>

            <div class="success">
                ‚úì Ruche cr√©√©e avec succ√®s! Voici la configuration pour votre Arduino.
            </div>

            <div class="steps">
                <div class="step">
                    <strong>Copiez ces informations dans votre code Arduino:</strong>
                    <div class="config-box" id="arduino-config"></div>
                    <button class="copy-btn" onclick="copyConfig()">üìã Copier la Configuration</button>
                </div>

                <div class="step">
                    <strong>Flashez votre ESP32/Arduino</strong>
                    <p style="margin-top: 10px; color: #6b7280;">
                        T√©l√©versez le code sur votre carte via Arduino IDE ou PlatformIO
                    </p>
                </div>

                <div class="step">
                    <strong>Branchez et d√©ployez</strong>
                    <p style="margin-top: 10px; color: #6b7280;">
                        L'Arduino va automatiquement se connecter et envoyer les donn√©es au serveur
                    </p>
                </div>
            </div>

            <div class="info" style="margin-top: 20px;">
                <strong>üìñ Documentation compl√®te:</strong> Voir
                <a href="/ARDUINO-INTEGRATION.md" target="_blank" style="color: #2563eb;">ARDUINO-INTEGRATION.md</a>
            </div>

            <button onclick="closeModal()" style="margin-top: 20px; width: 100%;">Fermer</button>
        </div>
    </div>

    <script>
        const TOKEN = localStorage.getItem('token');
        let currentApiKey = '';

        if (!TOKEN) {
            window.location.href = '/login.html';
        }

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${TOKEN}` },
                    credentials: 'include'
                });
                if (response.ok) {
                    const user = await response.json();
                    const userText = `${user.prenom} ${user.nom} (${user.organisation_nom})`;
                    document.getElementById('user-info-nav').textContent = userText;
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        loadUserInfo();

        async function addRuche() {
            const name = document.getElementById('ruche-name').value.trim();
            const location = document.getElementById('ruche-location').value.trim();
            const notes = document.getElementById('ruche-notes').value.trim();
            const btn = document.getElementById('add-btn');
            const message = document.getElementById('message');

            if (!name || !location) {
                message.innerHTML = '<div class="error">Veuillez remplir tous les champs obligatoires</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Ajout en cours...';
            message.innerHTML = '';

            try {
                // First, ensure we have an API key
                if (!currentApiKey) {
                    const keyResponse = await fetch('/api/iot/generate-key', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${TOKEN}`
                        },
                        credentials: 'include',
                        body: JSON.stringify({ nom: 'Auto-generated for ruches' })
                    });

                    if (keyResponse.ok) {
                        const keyData = await keyResponse.json();
                        currentApiKey = keyData.api_key;
                    }
                }

                // Register ruche via IoT endpoint (simulating Arduino)
                const response = await fetch('/api/iot/register-ruche', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': currentApiKey
                    },
                    body: JSON.stringify({
                        nom: name,
                        localisation: location
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show configuration modal
                    showConfigModal(name, location, data.ruche_id);

                    // Reset form
                    document.getElementById('ruche-name').value = '';
                    document.getElementById('ruche-location').value = '';
                    document.getElementById('ruche-notes').value = '';

                    // Reload list
                    loadRuches();
                } else {
                    message.innerHTML = `<div class="error">‚úó Erreur: ${data.error}</div>`;
                }
            } catch (error) {
                message.innerHTML = '<div class="error">‚úó Erreur de connexion au serveur</div>';
            }

            btn.disabled = false;
            btn.textContent = 'Ajouter la Ruche';
        }

        function showConfigModal(name, location, rucheId) {
            const config = `/*
 * BeeGuardAI - Configuration Arduino/ESP32
 * Ruche: ${name}
 * Localisation: ${location}
 *
 * INSTRUCTIONS:
 * 1. Copiez tout ce code
 * 2. Collez-le dans Arduino IDE
 * 3. Installez la biblioth√®que: ESP32 HTTPClient
 * 4. Changez WIFI_SSID et WIFI_PASSWORD
 * 5. Uploadez sur votre ESP32
 */

#include <WiFi.h>
#include <HTTPClient.h>

// ===== CONFIGURATION WIFI =====
const char* WIFI_SSID = "VOTRE_WIFI";        // ‚Üê Changez ici
const char* WIFI_PASSWORD = "VOTRE_PASSWORD"; // ‚Üê Changez ici

// ===== CONFIGURATION BEEGUARDAI (NE PAS MODIFIER) =====
const char* SERVER_URL = "http://192.168.1.100:3000/api/iot/data";
const char* API_KEY = "${currentApiKey}";
const int RUCHE_ID = ${rucheId};
const char* RUCHE_NAME = "${name}";

void setup() {
  Serial.begin(115200);

  // Connexion WiFi
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connexion WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println(" Connect√©!");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());
}

void loop() {
  // ===== LECTURE DES CAPTEURS =====
  int nombre_frelons = random(0, 5);           // ‚Üê Remplacez par votre capteur
  int abeilles_entrees = random(10, 50);       // ‚Üê Remplacez par votre capteur
  int abeilles_sorties = random(10, 50);       // ‚Üê Remplacez par votre capteur
  float temperature = random(15, 35);          // ‚Üê Remplacez par votre capteur DHT22
  float humidite = random(40, 80);             // ‚Üê Remplacez par votre capteur DHT22

  // ===== ENVOI DES DONN√âES =====
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(SERVER_URL);
    http.addHeader("Content-Type", "application/json");
    http.addHeader("X-API-Key", API_KEY);

    // Construction du JSON
    String jsonData = "{\\"ruche_id\\":" + String(RUCHE_ID) +
                      ",\\"nombre_frelons\\":" + String(nombre_frelons) +
                      ",\\"nombre_abeilles_entrees\\":" + String(abeilles_entrees) +
                      ",\\"nombre_abeilles_sorties\\":" + String(abeilles_sorties) +
                      ",\\"temperature\\":" + String(temperature) +
                      ",\\"humidite\\":" + String(humidite) + "}";

    // Envoi
    int httpCode = http.POST(jsonData);

    if (httpCode > 0) {
      Serial.println("‚úì Donn√©es envoy√©es: " + jsonData);
      Serial.println("  Code: " + String(httpCode));
    } else {
      Serial.println("‚úó Erreur d'envoi: " + String(httpCode));
    }

    http.end();
  } else {
    Serial.println("‚úó WiFi d√©connect√©");
  }

  // Attendre 5 minutes avant le prochain envoi
  delay(300000);
}`;

            document.getElementById('arduino-config').textContent = config;
            document.getElementById('config-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('config-modal').classList.remove('active');
        }

        function copyConfig() {
            const config = document.getElementById('arduino-config').textContent;
            navigator.clipboard.writeText(config).then(() => {
                alert('Configuration copi√©e!');
            });
        }

        async function loadRuches() {
            try {
                const response = await fetch('/api/ruches', {
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    credentials: 'include'
                });

                const ruches = await response.json();
                const container = document.getElementById('ruches-list');

                if (ruches.length === 0) {
                    container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">Aucune ruche enregistr√©e. Ajoutez-en une ci-dessus.</p>';
                    return;
                }

                container.innerHTML = ruches.map(ruche => `
                    <div class="ruche-item">
                        <div class="ruche-info">
                            <div class="ruche-name">${ruche.nom}</div>
                            <div class="ruche-location">üìç ${ruche.localisation}</div>
                            <div class="ruche-meta">
                                ID: ${ruche.id} |
                                Cr√©√©e: ${new Date(ruche.date_creation).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                        <div class="ruche-actions">
                            <button onclick="viewRucheConfig(${ruche.id}, '${ruche.nom}', '${ruche.localisation}')" class="secondary">
                                Voir Config
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading ruches:', error);
            }
        }

        async function viewRucheConfig(id, name, location) {
            // Ensure we have API key
            if (!currentApiKey) {
                try {
                    const response = await fetch('/api/iot/keys', {
                        headers: {
                            'Authorization': `Bearer ${TOKEN}`
                        },
                        credentials: 'include'
                    });

                    const keys = await response.json();
                    if (keys.length > 0) {
                        // Get the full key (we need to generate a new one or use existing)
                        alert('Veuillez d\'abord g√©n√©rer une cl√© API dans la page API Keys');
                        return;
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            showConfigModal(name, location, id);
        }

        async function logout() {
            await fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        // Load initial data
        loadRuches();

        // Load existing API key if any
        fetch('/api/iot/keys', {
            headers: {
                'Authorization': `Bearer ${TOKEN}`
            },
            credentials: 'include'
        })
        .then(r => r.json())
        .then(keys => {
            if (keys.length > 0) {
                // We have keys but they're masked, we'll generate a new one when needed
                console.log('API keys exist');
            }
        });
    </script>
</body>
</html>
